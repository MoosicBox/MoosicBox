name: 'Cache Artifact'
description: 'Checksums a directory and conditionally runs commands with intelligent artifact caching'
author: 'MoosicBox'

inputs:
    directory:
        description: 'Directory to checksum for change detection'
        required: true
    command:
        description: 'Custom command to run when changes are detected'
        required: true
    output-path:
        description: 'Path to the output file/artifact created by the command'
        required: true
    artifact-name:
        description: 'Name for the artifact (defaults to directory name + checksum)'
        required: false
        default: ''
    cache-key-prefix:
        description: 'Prefix for cache keys (defaults to repository name)'
        required: false
        default: ''
    working-directory:
        description: 'Working directory to run the command in'
        required: false
        default: '.'
    shell:
        description: 'Shell to use for running commands'
        required: false
        default: 'bash'
    make-executable:
        description: 'Whether to make the output file executable'
        required: false
        default: 'false'
    verify-command:
        description: 'Command to run to verify the output works (e.g., "--version")'
        required: false
        default: ''

outputs:
    cache-hit:
        description: 'Whether the cache was hit (true/false)'
        value: ${{ steps.cache-check.outputs.cache-hit }}
    checksum:
        description: 'The computed checksum of the directory'
        value: ${{ steps.compute-checksum.outputs.checksum }}
    artifact-name:
        description: 'The name of the uploaded/downloaded artifact'
        value: ${{ steps.set-artifact-name.outputs.artifact-name }}

runs:
    using: 'composite'
    steps:
        - name: Set up artifact name
          id: set-artifact-name
          shell: ${{ inputs.shell }}
          run: |
              if [ -n "${{ inputs.artifact-name }}" ]; then
                ARTIFACT_NAME="${{ inputs.artifact-name }}"
              else
                DIR_NAME=$(basename "${{ inputs.directory }}")
                ARTIFACT_NAME="${DIR_NAME}-cache"
              fi
              echo "artifact-name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT
              echo "ğŸ·ï¸ Artifact name: ${ARTIFACT_NAME}"

        - name: Compute directory checksum
          id: compute-checksum
          shell: ${{ inputs.shell }}
          run: |
              echo "ğŸ“ Computing checksum for directory: ${{ inputs.directory }}"
              if [ ! -d "${{ inputs.directory }}" ]; then
                echo "âŒ Directory ${{ inputs.directory }} does not exist!"
                exit 1
              fi

              # Create a deterministic checksum of the directory
              # Using find to get all files, then checksumming their content and paths
              CHECKSUM=$(find "${{ inputs.directory }}" -type f -exec sha256sum {} + | sort -k2 | sha256sum | cut -d' ' -f1)
              echo "checksum=${CHECKSUM}" >> $GITHUB_OUTPUT
              echo "âœ… Directory checksum: ${CHECKSUM}"

        - name: Set cache key
          id: set-cache-key
          shell: ${{ inputs.shell }}
          run: |
              PREFIX="${{ inputs.cache-key-prefix }}"
              if [ -z "$PREFIX" ]; then
                PREFIX="${{ github.repository }}"
              fi
              CACHE_KEY="${PREFIX}-${{ steps.set-artifact-name.outputs.artifact-name }}-${{ steps.compute-checksum.outputs.checksum }}"
              echo "cache-key=${CACHE_KEY}" >> $GITHUB_OUTPUT
              echo "ğŸ”‘ Cache key: ${CACHE_KEY}"

        - name: Check for existing cache
          id: cache-check
          uses: actions/cache/restore@v4
          with:
              path: ${{ inputs.output-path }}
              key: ${{ steps.set-cache-key.outputs.cache-key }}
              lookup-only: true

        - name: Restore cache
          if: steps.cache-check.outputs.cache-hit == 'true'
          id: cache-restore
          uses: actions/cache/restore@v4
          with:
              path: ${{ inputs.output-path }}
              key: ${{ steps.set-cache-key.outputs.cache-key }}

        - name: Check for existing artifact
          if: steps.cache-check.outputs.cache-hit != 'true'
          id: check-artifact
          shell: ${{ inputs.shell }}
          run: |
              ARTIFACT_NAME="${{ steps.set-artifact-name.outputs.artifact-name }}-${{ steps.compute-checksum.outputs.checksum }}"
              echo "ğŸ” Checking for existing artifact: $ARTIFACT_NAME"

              # Use GitHub API to check if artifact exists
              ARTIFACT_EXISTS=$(curl -s \
                  -H "Authorization: Bearer ${{ github.token }}" \
                  -H "Accept: application/vnd.github.v3+json" \
                  "https://api.github.com/repos/${{ github.repository }}/actions/artifacts?name=$ARTIFACT_NAME" \
                  | jq -r '.artifacts | length > 0')

              echo "artifact-exists=$ARTIFACT_EXISTS" >> $GITHUB_OUTPUT

              if [ "$ARTIFACT_EXISTS" = "true" ]; then
                  echo "âœ… Artifact found: $ARTIFACT_NAME"
              else
                  echo "âŒ Artifact not found: $ARTIFACT_NAME (will build from scratch)"
              fi

        - name: Download existing artifact
          if: steps.cache-check.outputs.cache-hit != 'true' && steps.check-artifact.outputs.artifact-exists == 'true'
          id: download-artifact
          uses: actions/download-artifact@v4
          with:
              name: ${{ steps.set-artifact-name.outputs.artifact-name }}-${{ steps.compute-checksum.outputs.checksum }}
              path: ${{ inputs.working-directory }}

        - name: Run custom command
          if: steps.cache-check.outputs.cache-hit != 'true' && (steps.check-artifact.outputs.artifact-exists != 'true' || steps.download-artifact.outcome == 'failure')
          shell: ${{ inputs.shell }}
          working-directory: ${{ inputs.working-directory }}
          run: |
              echo "ğŸš€ Running custom command: ${{ inputs.command }}"
              echo "ğŸ“‚ Working directory: ${{ inputs.working-directory }}"
              ${{ inputs.command }}

              # Verify the output was created
              if [ ! -e "${{ inputs.output-path }}" ]; then
                echo "âŒ Output file ${{ inputs.output-path }} was not created by the command!"
                exit 1
              fi
              echo "âœ… Command completed successfully, output created: ${{ inputs.output-path }}"

        - name: Save to cache
          if: steps.cache-check.outputs.cache-hit != 'true' && (steps.check-artifact.outputs.artifact-exists != 'true' || steps.download-artifact.outcome == 'failure')
          uses: actions/cache/save@v4
          with:
              path: ${{ inputs.output-path }}
              key: ${{ steps.set-cache-key.outputs.cache-key }}

        - name: Upload artifact
          if: steps.cache-check.outputs.cache-hit != 'true' && (steps.check-artifact.outputs.artifact-exists != 'true' || steps.download-artifact.outcome == 'failure')
          uses: actions/upload-artifact@v4
          with:
              name: ${{ steps.set-artifact-name.outputs.artifact-name }}-${{ steps.compute-checksum.outputs.checksum }}
              path: ${{ inputs.output-path }}
              retention-days: 30
              compression-level: 9

        - name: Setup output file
          shell: ${{ inputs.shell }}
          run: |
              # Make executable if requested
              if [ "${{ inputs.make-executable }}" = "true" ]; then
                echo "ğŸ”§ Making output file executable..."
                chmod +x "${{ inputs.output-path }}"
              fi

              # Log detailed info
              echo "ğŸ”§ Output file status:"
              echo "  - Cache hit: ${{ steps.cache-check.outputs.cache-hit }}"
              echo "  - Checksum: ${{ steps.compute-checksum.outputs.checksum }}"
              if [ -f "${{ inputs.output-path }}" ]; then
                echo "  - File size: $(du -h "${{ inputs.output-path }}" | cut -f1)"
                echo "  - File path: $(readlink -f "${{ inputs.output-path }}")"
                if [ "${{ inputs.make-executable }}" = "true" ]; then
                  echo "  - Executable: $(ls -la "${{ inputs.output-path }}" | cut -d' ' -f1)"
                fi
              fi

              # Verify the output works if verification command provided
              if [ -n "${{ inputs.verify-command }}" ]; then
                echo "ğŸ§ª Verifying output file..."
                "${{ inputs.output-path }}" ${{ inputs.verify-command }}
                echo "âœ… Output file verification successful"
              fi

        - name: Report cache status
          shell: ${{ inputs.shell }}
          run: |
              if [ "${{ steps.cache-check.outputs.cache-hit }}" = "true" ]; then
                echo "ğŸ¯ Cache HIT! Using cached version of ${{ inputs.output-path }}"
              elif [ "${{ steps.check-artifact.outputs.artifact-exists }}" = "true" ] && [ "${{ steps.download-artifact.outcome }}" = "success" ]; then
                echo "ğŸ“¦ Artifact downloaded successfully"
              elif [ "${{ steps.check-artifact.outputs.artifact-exists }}" = "true" ] && [ "${{ steps.download-artifact.outcome }}" = "failure" ]; then
                echo "âš ï¸ Artifact exists but download failed - built new version"
              else
                echo "ğŸ”¨ No existing cache or artifact found - built new version"
              fi

              echo "ğŸ“Š Summary:"
              echo "  - Directory: ${{ inputs.directory }}"
              echo "  - Checksum: ${{ steps.compute-checksum.outputs.checksum }}"
              echo "  - Cache Key: ${{ steps.set-cache-key.outputs.cache-key }}"
              echo "  - Artifact: ${{ steps.set-artifact-name.outputs.artifact-name }}-${{ steps.compute-checksum.outputs.checksum }}"
              echo "  - Output: ${{ inputs.output-path }}"
              if [ "${{ steps.cache-check.outputs.cache-hit }}" != "true" ]; then
                echo "  - Artifact exists: ${{ steps.check-artifact.outputs.artifact-exists }}"
              fi

branding:
    icon: 'package'
    color: 'blue'
