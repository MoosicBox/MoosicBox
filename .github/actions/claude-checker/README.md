# Claude Checker Action

Generic Claude-based documentation and code checker with customizable prompt templates and multi-command workflow orchestration.

## Overview

This action provides a flexible, template-driven system for running Claude Code checks on your repository. It supports:

- **Built-in templates** for common checks (README, rustdoc, examples, issue handling, PR comments, code review)
- **Custom templates** via file path or inline text
- **Variable interpolation** with YAML frontmatter defaults
- **Priority-based variable resolution** (user vars > template defaults > auto-detected)
- **Verification profiles** for different project types (Rust, TypeScript, Python, etc.)
- **Multi-command architecture** for workflow orchestration (branch management, PR creation)

## Commands

This action supports three commands via the `command` input:

### 1. `check` (default)

Run Claude Code checks with templates and commit changes.

### 2. `create-branch`

Create or checkout a branch for updates. Useful for multi-job workflows where you want to coordinate branch creation across jobs.

### 3. `create-pr`

Create or update a pull request for a branch. Handles checking for existing PRs, creating new ones, or updating existing ones.

## Quick Start

### Basic Usage (README Checker)

```yaml
- uses: MoosicBox/MoosicBox/.github/actions/claude-checker@v1
  with:
      github_token: ${{ secrets.GITHUB_TOKEN }}
      claude_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      prompt_template: 'readme'
```

This will check the root README.md using all default settings.

### Package README

```yaml
- uses: MoosicBox/MoosicBox/.github/actions/claude-checker@v1
  with:
      github_token: ${{ secrets.GITHUB_TOKEN }}
      claude_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      prompt_template: 'readme'
      template_vars: |
          package_path: packages/audio
```

### Create Branch Command

```yaml
- name: Create update branch
  id: branch
  uses: MoosicBox/MoosicBox/.github/actions/claude-checker@v1
  with:
      command: create-branch
      github_token: ${{ secrets.GITHUB_TOKEN }}
      branch_prefix: readme-updates

- name: Use branch in later steps
  run: echo "Branch: ${{ steps.branch.outputs.branch_name }}"
```

### Create PR Command

```yaml
- name: Create or update PR
  uses: MoosicBox/MoosicBox/.github/actions/claude-checker@v1
  with:
      command: create-pr
      github_token: ${{ secrets.GITHUB_TOKEN }}
      branch_name: readme-updates-12345
      pr_title: 'üìù Automated README Updates'
      pr_body: |
          ## Automated Updates

          Changes generated by Claude Checker Action.

          **Branch:** `${branch_name}`
          **Run:** ${run_url}
      pr_labels: 'automated,documentation'
```

### Complete Multi-Job Workflow Example

```yaml
jobs:
    create-branch:
        runs-on: ubuntu-latest
        outputs:
            branch-name: ${{ steps.branch.outputs.branch_name }}
        steps:
            - uses: actions/checkout@v4
            - name: Create branch
              id: branch
              uses: MoosicBox/MoosicBox/.github/actions/claude-checker@v1
              with:
                  command: create-branch
                  github_token: ${{ secrets.GITHUB_TOKEN }}

    update-docs:
        needs: [create-branch]
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  ref: ${{ needs.create-branch.outputs.branch-name }}

            - uses: MoosicBox/MoosicBox/.github/actions/claude-checker@v1
              with:
                  command: check # or omit (default)
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  claude_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
                  prompt_template: 'readme'
                  branch_name: ${{ needs.create-branch.outputs.branch-name }}

    create-pr:
        needs: [create-branch, update-docs]
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  ref: ${{ needs.create-branch.outputs.branch-name }}

            - uses: MoosicBox/MoosicBox/.github/actions/claude-checker@v1
              with:
                  command: create-pr
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  branch_name: ${{ needs.create-branch.outputs.branch-name }}
                  pr_title: 'üìù Documentation Updates'
                  pr_body: 'Automated documentation updates from Claude'
```

## Inputs

### Command

| Input     | Description                                           | Default |
| --------- | ----------------------------------------------------- | ------- |
| `command` | Command to run: `check`, `create-branch`, `create-pr` | `check` |

### Required

| Input          | Description                                                 |
| -------------- | ----------------------------------------------------------- |
| `github_token` | GitHub token with write permissions (required for all)      |
| `claude_token` | Claude Code OAuth token (required for `check` command only) |

### Prompt Template (required for `check` command)

| Input                  | Description                                                                           |
| ---------------------- | ------------------------------------------------------------------------------------- |
| `prompt_template`      | Built-in template name: `readme`, `rustdoc`, `examples`, `issue`, `pr`, `code-review` |
| `prompt_template_file` | Path to custom template file                                                          |
| `prompt_template_text` | Inline template text                                                                  |

### Branch Management (`create-branch` command)

| Input             | Description                           | Default                   |
| ----------------- | ------------------------------------- | ------------------------- |
| `branch_name`     | Branch name (auto-generated if empty) |                           |
| `branch_prefix`   | Branch prefix for auto-generation     | `claude-updates`          |
| `existing_branch` | Use existing branch if it exists      | `true`                    |
| `git_user_name`   | Git user name for commits             | `github-actions[bot]`     |
| `git_user_email`  | Git user email                        | `github-actions[bot]@...` |

### PR Creation (`create-pr` command)

| Input                   | Description                          | Default                            |
| ----------------------- | ------------------------------------ | ---------------------------------- |
| `branch_name`           | Branch name (required for create-pr) |                                    |
| `pr_base_branch`        | Base branch for PR                   | `master`                           |
| `pr_title`              | PR title (supports ${variables})     | `üìù Automated updates from Claude` |
| `pr_body`               | PR body (supports ${variables})      | `""`                               |
| `pr_labels`             | Comma-separated PR labels            | `automated`                        |
| `pr_skip_if_no_changes` | Skip PR creation if no changes       | `true`                             |

### Optional (`check` command)

| Input                              | Description                                                              | Default                           |
| ---------------------------------- | ------------------------------------------------------------------------ | --------------------------------- |
| `template_vars`                    | YAML/JSON object of variables                                            | `{}`                              |
| `verification_profile`             | Built-in profile: `auto`, `rust`, `typescript`, `python`, `go`, `custom` | `auto`                            |
| `verification_config_file`         | Path to verification config YAML                                         | `.github/claude-verification.yml` |
| `verification_config_inline`       | Inline verification config (YAML)                                        |                                   |
| `branch_name`                      | Branch to commit to (overrides template default)                         |                                   |
| `commit_message`                   | Commit message (supports template variables)                             |                                   |
| `auto_commit`                      | Automatically commit changes                                             | `true`                            |
| `enable_execution_details_summary` | Post execution details to workflow summary                               | `false`                           |
| `summary_title`                    | Title for workflow summary section                                       | `üí≠ Claude Execution Details`     |
| `model`                            | Claude model                                                             |                                   |
| `max_tokens`                       | Max tokens                                                               |                                   |
| `max_turns`                        | Max turns                                                                |                                   |
| `claude_args`                      | Additional Claude Code arguments                                         |                                   |
| `working_directory`                | Working directory                                                        | `.`                               |

## Outputs

### All Commands

| Output        | Description      |
| ------------- | ---------------- |
| `branch_name` | Branch name used |

### `check` Command Outputs

| Output                   | Description                                                    |
| ------------------------ | -------------------------------------------------------------- |
| `has_changes`            | `true` if changes were made                                    |
| `files_changed`          | Space-separated list of changed files                          |
| `execution_file`         | Path to execution details file                                 |
| `resolved_template_vars` | JSON object of all resolved template variables (for debugging) |
| `push_status`            | Push status: `success`, `no_changes`, `fallback`, `failed`     |
| `push_branch`            | Branch pushed to                                               |
| `fallback_branch`        | Fallback branch (if created)                                   |
| `compare_url`            | Compare URL for fallback                                       |
| `commit_created`         | `true` if commit was created                                   |
| `summary_posted`         | `true` if execution details were posted to workflow summary    |

### `create-branch` Command Outputs

| Output          | Description                      |
| --------------- | -------------------------------- |
| `branch_exists` | `true` if branch already existed |
| `branch_action` | `created` or `checked_out`       |

### `create-pr` Command Outputs

| Output        | Description                          |
| ------------- | ------------------------------------ |
| `pr_created`  | `true` if PR was created or updated  |
| `pr_number`   | PR number                            |
| `pr_url`      | PR URL                               |
| `pr_action`   | `created`, `updated`, or `skipped`   |
| `has_changes` | `true` if branch has changes vs base |

## Template System

### Variable Resolution Priority

1. **User-provided `template_vars`** (highest priority)
2. **Template frontmatter defaults**
3. **Auto-detected from GitHub context** (lowest priority)

### Frontmatter Format

Templates use YAML frontmatter to define default variable values:

```markdown
---
# Default variables
project_name: ${repository_name}
package_path: .
custom_variable: some_value
---

# Your prompt template starts here

Use ${project_name} and ${custom_variable} in your template.
```

### Variable Interpolation

Use `${var_name}` syntax in templates:

```markdown
Project: ${project_name}
Package: ${package_name}
```

Supports expressions:

```markdown
${condition ? 'true_value' : 'false_value'}
${var1 + '-' + var2}
```

### Auto-Detected Variables

Always available:

```yaml
repository: 'owner/repo'
repository_owner: 'owner'
repository_name: 'repo'
run_id: '123456'
sha: 'abc123...'
actor: 'username'

# Event-specific (when available)
github_event_issue_number: '123'
github_event_issue_title: 'Issue title'
github_event_pull_request_number: '456'
# ... and many more
```

## Built-in Templates

### `readme`

Validates README accuracy against codebase.

**Default Variables:**

```yaml
project_name: ${repository_name}
package_path: .
readme_path: README.md
is_root_readme: ${readme_path == 'README.md'}
branch_name: ${is_root_readme ? 'docs/root-readme-updates-' + run_id : 'docs/readme-updates-' + run_id}
```

**Usage:**

```yaml
# Root README
- uses: MoosicBox/MoosicBox/.github/actions/claude-checker@v1
  with:
      github_token: ${{ secrets.GITHUB_TOKEN }}
      claude_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      prompt_template: 'readme'

# Package README
- uses: MoosicBox/MoosicBox/.github/actions/claude-checker@v1
  with:
      github_token: ${{ secrets.GITHUB_TOKEN }}
      claude_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      prompt_template: 'readme'
      template_vars: |
          package_path: packages/my-package
```

### `rustdoc` (TODO)

Ensures complete rustdoc for public APIs.

### `examples` (TODO)

Validates and creates examples.

### `issue` (TODO)

Handles @claude mentions in GitHub issues.

### `pr` (TODO)

Handles @claude mentions in PR comments.

### `code-review` (TODO)

Automated code review on PR open/sync.

## Custom Templates

### From File

```yaml
- uses: MoosicBox/MoosicBox/.github/actions/claude-checker@v1
  with:
      github_token: ${{ secrets.GITHUB_TOKEN }}
      claude_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      prompt_template_file: '.github/prompts/security-audit.md'
      template_vars: |
          severity: high
          scope: auth/
```

### Inline

```yaml
- uses: MoosicBox/MoosicBox/.github/actions/claude-checker@v1
  with:
      github_token: ${{ secrets.GITHUB_TOKEN }}
      claude_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      prompt_template_text: |
          ---
          target: ${package_path}/README.md
          ---

          Check ${target} for accuracy.
      template_vars: |
          package_path: packages/core
```

## Verification System

### Built-in Profiles

- `auto`: Auto-detect from repo files
- `rust`: cargo fmt, clippy, machete, prettier, taplo
- `typescript`: prettier, eslint, tsc
- `python`: black, ruff, mypy
- `go`: gofmt, golangci-lint
- `custom`: Read from config file

### Verification Config File

Create `.github/claude-verification.yml`:

```yaml
# Setup steps (run once)
setup:
    - name: Install cargo-machete
      run: cargo install cargo-machete || true

# Verification steps (run before each commit)
verification:
    format:
        - name: Format Rust
          run: cargo fmt
          when: rust_files_changed

        - name: Format Markdown
          run: npx prettier --write "**/*.md"
          when: markdown_files_changed

    lint:
        - name: Clippy
          run: cargo clippy --all-targets -- -D warnings
          when: rust_files_changed
          required: true
# Conditions: always, never, *_files_changed, package_changed, files_match:"pattern"
```

## Examples

### README Checker in Matrix

```yaml
jobs:
    check-readmes:
        strategy:
            matrix:
                package: [audio, player, server]
        steps:
            - uses: actions/checkout@v4

            - uses: MoosicBox/MoosicBox/.github/actions/claude-checker@v1
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  claude_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
                  prompt_template: 'readme'
                  template_vars: |
                      package_path: packages/${{ matrix.package }}
                  branch_name: readme-updates-${{ github.run_id }}
```

### TypeScript Project

```yaml
- uses: MoosicBox/MoosicBox/.github/actions/claude-checker@v1
  with:
      github_token: ${{ secrets.GITHUB_TOKEN }}
      claude_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      prompt_template: 'readme'
      verification_profile: 'typescript'
      template_vars: |
          package_path: packages/auth
```

### With Custom Guidelines

```yaml
- uses: MoosicBox/MoosicBox/.github/actions/claude-checker@v1
  with:
      github_token: ${{ secrets.GITHUB_TOKEN }}
      claude_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      prompt_template: 'readme'
      template_vars: |
          package_path: packages/audio
          custom_guidelines: |
            ## Audio Package Specifics
            - Document all supported codecs
            - Include performance benchmarks
```

## Execution Details

The claude-checker action can provide detailed execution information showing how Claude worked on the task. This includes tool usage, thinking process, token counts, and costs.

### Workflow Summary

Post the "üí≠ How I worked on this" details directly to the GitHub Actions workflow summary page (visible on the workflow run page).

**Example:**

```yaml
- uses: MoosicBox/MoosicBox/.github/actions/claude-checker@v1
  with:
      github_token: ${{ secrets.GITHUB_TOKEN }}
      claude_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      prompt_template: 'readme'
      enable_execution_details_summary: 'true'
      summary_title: 'üí≠ README Update Details'
```

**Use Cases:**

- Quick visibility without downloading artifacts
- Permanent record in workflow run page
- Easier to review in PR checks tab
- Great for CI/CD transparency

**Combines With:**

- Can be used together with `enable_execution_details_artifact` for downloadable records
- Can be used with `enable_execution_details` for inline comment visibility
- All three options (summary, artifact, comment) work independently or together

### Artifacts

Upload execution details as a downloadable artifact:

```yaml
- uses: MoosicBox/MoosicBox/.github/actions/claude-checker@v1
  with:
      github_token: ${{ secrets.GITHUB_TOKEN }}
      claude_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      prompt_template: 'readme'
      enable_execution_details_artifact: 'true'
      artifact_name_prefix: 'readme'
      artifact_package_name: 'my-package'
      artifact_retention_days: '30'
```

### Comment Appending

Append execution details to GitHub issue/PR comments:

```yaml
- uses: MoosicBox/MoosicBox/.github/actions/claude-checker@v1
  with:
      github_token: ${{ secrets.GITHUB_TOKEN }}
      claude_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      prompt_template: 'readme'
      enable_execution_details: 'true'
      acknowledgment_comment_id: ${{ steps.comment.outputs.comment_id }}
```

### All Three Together

```yaml
- uses: MoosicBox/MoosicBox/.github/actions/claude-checker@v1
  with:
      github_token: ${{ secrets.GITHUB_TOKEN }}
      claude_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      prompt_template: 'readme'
      # Summary for quick access
      enable_execution_details_summary: 'true'
      summary_title: 'üí≠ How Claude Updated README'
      # Artifact for long-term storage
      enable_execution_details_artifact: 'true'
      artifact_retention_days: '90'
      # Comment for PR visibility
      enable_execution_details: 'true'
```

## Development

### Testing Changes

```bash
cd .github/actions/claude-checker
npm install
npm test  # TODO: Add tests
```

### Adding New Built-in Templates

1. Create template file in `templates/` with frontmatter
2. Document in this README
3. Add tests

## License

Same as parent repository.
