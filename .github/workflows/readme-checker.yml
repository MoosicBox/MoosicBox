name: README Accuracy Checker

on:
    schedule:
        - cron: "0 8 * * 1"
    workflow_dispatch:
        inputs:
            existing_branch:
                description: "Use existing branch (leave empty to create new)"
                required: false
                type: string
                default: ""

            packages:
                description: "Comma-separated packages (leave empty for all)"
                required: false
                type: string
                default: ""

            prompt_override:
                description: "Additional guidance or custom prompt"
                required: false
                type: string
                default: ""

            model:
                description: "Claude model to use (leave empty for latest default)"
                required: false
                type: choice
                options:
                    - ""
                    - "claude-sonnet-4-5-20250929"
                    - "claude-opus-4-1-20250805"
                    - "claude-opus-4-20250514"
                    - "claude-sonnet-4-20250514"
                    - "claude-3-7-sonnet-20250219"
                    - "claude-3-5-haiku-20241022"
                    - "claude-3-haiku-20240307"
                default: ""

            max_tokens:
                description: "Maximum tokens per request (leave empty for default)"
                required: false
                type: string
                default: ""

            max_turns:
                description: "Maximum conversation turns (leave empty for default)"
                required: false
                type: string
                default: ""

env:
    CARGO_TERM_COLOR: always

jobs:
    create-branch:
        name: Create or use existing branch
        runs-on: ubuntu-latest
        outputs:
            branch-name: ${{ steps.branch.outputs.name }}
            branch-date: ${{ steps.branch.outputs.date }}
            is-new: ${{ steps.branch.outputs.is_new }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.MOOSICBOX_BOT_UPGRADES_TOKEN }}
                  fetch-depth: 0

            - name: Determine branch to use
              id: branch
              run: |
                  if [ -n "${{ inputs.existing_branch }}" ]; then
                    BRANCH_NAME="${{ inputs.existing_branch }}"

                    if ! git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
                      echo "âŒ Error: Branch '$BRANCH_NAME' does not exist"
                      exit 1
                    fi

                    echo "Using existing branch: $BRANCH_NAME"
                    echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT
                    echo "is_new=false" >> $GITHUB_OUTPUT

                    if [[ "$BRANCH_NAME" =~ readme-updates-([0-9]{14}) ]]; then
                      echo "date=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
                    else
                      echo "date=existing" >> $GITHUB_OUTPUT
                    fi
                  else
                    BRANCH_DATE=$(date +%Y%m%d%H%M%S)
                    BRANCH_NAME="readme-updates-${BRANCH_DATE}-${{ github.run_id }}"

                    RETRY_SUFFIX=""
                    if [ "${{ github.run_attempt }}" -gt 1 ]; then
                      RETRY_SUFFIX="-${{ github.run_attempt }}"
                    fi

                    FULL_BRANCH="${BRANCH_NAME}${RETRY_SUFFIX}"

                    echo "Creating new branch: $FULL_BRANCH"
                    echo "name=$FULL_BRANCH" >> $GITHUB_OUTPUT
                    echo "date=$BRANCH_DATE" >> $GITHUB_OUTPUT
                    echo "is_new=true" >> $GITHUB_OUTPUT
                  fi

            - name: Configure Git
              run: |
                  git config user.name "MoosicBoxBot"
                  git config user.email "MoosicBoxBot@gmail.com"

            - name: Create new branch
              if: steps.branch.outputs.is_new == 'true'
              run: |
                  git checkout -b ${{ steps.branch.outputs.name }}
                  git push origin ${{ steps.branch.outputs.name }}

            - name: Checkout existing branch
              if: steps.branch.outputs.is_new == 'false'
              run: |
                  git fetch origin ${{ steps.branch.outputs.name }}
                  git checkout ${{ steps.branch.outputs.name }}
                  echo "âœ… Checked out existing branch: ${{ steps.branch.outputs.name }}"

    determine-packages:
        name: Determine packages to update
        runs-on: ubuntu-latest
        needs: [create-branch]
        outputs:
            matrix: ${{ steps.analyze.outputs.matrix }}
            has-packages: ${{ steps.analyze.outputs.has-changes }}
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - uses: dtolnay/rust-toolchain@stable

            - name: Generate package matrix
              id: analyze
              uses: ./.github/actions/clippier
              with:
                  command: packages
                  packages: ${{ github.event.inputs.packages }}
                  skip-on-no-changes: "false"
                  force-full-matrix-condition: "true"
                  os: "ubuntu"

    update-readmes:
        name: Update ${{ matrix.package.name }}
        runs-on: ubuntu-latest
        needs: [create-branch, determine-packages]
        if: needs.determine-packages.outputs.has-packages == 'true'
        strategy:
            fail-fast: false
            max-parallel: 20
            matrix:
                package: ${{ fromJson(needs.determine-packages.outputs.matrix) }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: ${{ needs.create-branch.outputs.branch-name }}
                  fetch-depth: 0
                  token: ${{ secrets.MOOSICBOX_BOT_UPGRADES_TOKEN }}

            - name: Configure Git
              run: |
                  git config user.name "MoosicBoxBot"
                  git config user.email "MoosicBoxBot@gmail.com"

            - name: Check if README exists
              id: check_readme
              run: |
                  if [ -f "${{ matrix.package.path }}/README.md" ]; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                    echo "No README found for ${{ matrix.package.name }}, skipping"
                  fi

            - name: Update README with Claude
              if: steps.check_readme.outputs.exists == 'true'
              uses: BSteffaniak/claude-code-action@dev
              with:
                  claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
                  github_token: ${{ secrets.MOOSICBOX_BOT_UPGRADES_TOKEN }}

                  prompt: |
                      ${{
                        (inputs.existing_branch != '' && inputs.prompt_override != '' &&
                          format('# Additional README Refinement for {0}

                      This is a refinement pass on an existing README update branch.

                      ## Previous Context
                      The README at `{1}/README.md` has already been reviewed and potentially updated.

                      ## Additional Guidance
                      {2}

                      ## Requirements
                      - Review the current state of the README
                      - Apply the additional guidance above
                      - Only make changes that align with the new guidance
                      - Preserve previous improvements unless they conflict with new guidance

                      Focus on incremental improvements based on the additional guidance.',
                          matrix.package.name, matrix.package.path, inputs.prompt_override))
                        ||
                        (inputs.prompt_override != '' && inputs.prompt_override)
                        ||
                        (vars.README_UPDATE_PROMPT != '' && vars.README_UPDATE_PROMPT)
                        ||
                        format('# README Accuracy Review for {0}

                      ## âš ï¸ CRITICAL CONSTRAINT: FUNDAMENTAL ERRORS ONLY

                      You may ONLY make changes for these reasons:

                      **Fundamentally Incorrect:**
                      - README claims a feature that doesn''t exist in the code at `{1}/`
                      - Code examples show wrong function signatures (don''t match actual code in `{1}/src/`)
                      - Dependencies listed don''t match `{1}/Cargo.toml`
                      - Module/file references don''t match actual structure
                      - Links are broken or point to wrong locations

                      **Fundamentally Incomplete:**
                      - A major implemented feature is completely missing from README
                      - Critical usage information is absent (e.g., how to use the main API)

                      **FORBIDDEN Changes (even if you think they would be "better"):**
                      - âŒ Rewording for clarity, style, or tone
                      - âŒ Reorganizing sections or structure
                      - âŒ Formatting/markdown improvements
                      - âŒ Adding more examples when basics are already covered
                      - âŒ Expanding descriptions that are already accurate
                      - âŒ Minor completeness improvements
                      - âŒ Changing future tense to present or vice versa (if already marked correctly)
                      - âŒ Removing features that are configured/enabled even if not fully implemented
                      - âŒ Nitpicking wording differences when the meaning is substantially the same
                      - âŒ Including specific line numbers in code references (e.g., `src/file.rs:123`) - line numbers change frequently and should be omitted
                      - âŒ Including specific counts of tests/test cases (e.g., "5 test cases", "10 tests") - test counts change frequently and should be omitted

                      **Decision Rule:**
                      Before making ANY change, ask yourself:
                      1. "Would a user be MISLED or UNABLE TO USE this package because of this issue?"
                      2. "Am I removing information that is technically accurate based on configuration/capabilities?"
                      - If either is NO â†’ Leave it alone
                      - If both are YES â†’ Fix it (it''s fundamental)

                      **Examples of FORBIDDEN changes:**
                      - Changing "System notifications, tray integration, and OS-specific features" to just "System notification support" (removing configured capabilities)
                      - Changing "Media keys, notifications, and system tray" to "Media keys and notifications" (removing tray mention when capability exists)
                      - Simplifying feature lists that accurately describe configured functionality

                      ## ðŸ“– PUBLIC API FOCUS - Do Not Document Internals

                      READMEs are for **users of the package**, not maintainers. Only document the public-facing API.

                      **DO Document:**
                      - âœ… Public functions, structs, traits (items with `pub` visibility)
                      - âœ… Cargo features users can enable (e.g., `--features async`)
                      - âœ… Main entry points and usage patterns
                      - âœ… Public configuration options
                      - âœ… Integration examples for users

                      **DO NOT Document:**
                      - âŒ Internal macros (`macro_rules!` not in public API)
                      - âŒ Private or crate-private items (`pub(crate)`, `pub(super)`, or non-pub items)
                      - âŒ Implementation details (caches, thread pools, internal state)
                      - âŒ Test utilities or `#[cfg(test)]` code
                      - âŒ Build scripts or internal feature implementations
                      - âŒ Helper functions only used within the crate

                      **How to identify internal items when reviewing code:**
                      1. Check visibility: `pub` without qualifiers = Public âœ… | `pub(crate)` or no `pub` = Internal âŒ
                      2. Check if exported in `lib.rs` or module root = Public âœ…
                      3. Internal naming patterns (`_helper`, `internal_*`) = Internal âŒ
                      4. Only called within same crate = Internal âŒ

                      **Decision Rule for Documentation:**
                      When considering whether to document something, ask: "Would a user of this library as a dependency need to know this?"
                      - YES (it''s a public API they''ll call) â†’ Document it
                      - NO (it''s internal implementation) â†’ Leave it out or remove it

                      ## ðŸ“ Commit Message Instructions

                      If you make changes to the README, you MUST provide a commit message description.

                      At the END of your response, include a section formatted EXACTLY as follows:
                      ```
                      COMMIT_MESSAGE_START
                      - Brief description of what changed and why (1-2 sentences)
                      - Additional changes if applicable
                      COMMIT_MESSAGE_END
                      ```

                      Example:
                      ```
                      COMMIT_MESSAGE_START
                      - Removed claim about WebSocket support as the feature is not implemented in the codebase
                      - Added documentation for the new `connect_async` method which is exported in lib.rs but was missing from README
                      COMMIT_MESSAGE_END
                      ```

                      Requirements:
                      - Keep each bullet point concise (1-2 sentences max)
                      - Focus on WHAT changed and WHY (the fundamental issue)
                      - Use bullet points with dashes (-)
                      - Do not include code snippets or line numbers
                      - If no changes needed, output "No changes required - documentation is accurate"

                      ## Verification Process

                      1. **ðŸš« MANDATORY Git History Regression Check**

                         Before making ANY change to the README, you MUST check git history for the SPECIFIC LINES you want to modify.

                         **Required Commands:**
                         For each line or section you want to change, run:
                         ```bash
                         # Replace LINE_NUMBER with the actual line number you want to modify
                         # Add +/- 5 lines of context to catch related changes
                         git log -L LINE_NUMBER,+1:{1}/README.md --format="%H %s%n%b"

                         # For a section spanning multiple lines (e.g., lines 240-250):
                         git log -L 240,250:{1}/README.md --format="%H %s%n%b"
                         ```

                         **What to Look For:**
                         - **Revert commits**: Messages containing "revert", "revert back to", "prefer X format", "changed back to"
                         - **PR discussion references**: Look for "Triggered-by:" URLs in commit messages
                         - **Explicit reasoning**: Commit messages explaining "prefer X because Y" or "more concise", "better for readability"
                         - **Multiple attempts**: If the same change appears 2+ times in history, this is a STRONG SIGNAL

                         **Blocking Rules (NON-NEGOTIABLE):**
                         - âŒ **If you find a revert commit for the exact change you want to make**: STOP. DO NOT make that change.
                         - âŒ **If the same change was reverted 2+ times**: HARD STOP. The maintainers have decided against it.
                         - âŒ **If a commit contains "Triggered-by:" with a GitHub PR/discussion URL**: You MUST read that discussion to understand the reasoning before proceeding.
                         - âŒ **If unclear after reading history**: Leave it alone. Document the uncertainty in your output for human review.

                         **Decision Process:**
                         1. Run `git log -L` for the specific line(s) you want to change
                         2. Read ALL commit messages in the history (no arbitrary limits - check FULL history)
                         3. If you see a revert or "Triggered-by:" reference:
                            a. Extract the discussion URL if present
                            b. Understand why the change was reverted
                            c. If your proposed change matches what was reverted: BLOCK IT
                         4. Document your findings in a `REGRESSION_CHECK` block (format below)

                         **Required Output Format:**
                         For EVERY change you consider making, include this in your response:
                         ```
                         REGRESSION_CHECK_START
                         File: {1}/README.md
                         Line(s): [specific line numbers]
                         Proposed change: [brief description of what you wanted to do]
                         Git history checked: YES
                         Revert found: [YES/NO]
                         Revert details: [commit hash and reasoning if YES, otherwise "None found"]
                         Decision: [PROCEED/BLOCKED - explanation]
                         REGRESSION_CHECK_END
                         ```

                         **Example of BLOCKED change:**
                         ```
                         REGRESSION_CHECK_START
                         File: packages/clippier/README.md
                         Line(s): 244
                         Proposed change: Change --features "feature1,feature2" to --features feature1 --features feature2
                         Git history checked: YES
                         Revert found: YES
                         Revert details: Commit 27bb0ed83 reverted this exact change with reasoning "prefer comma-separated for conciseness" and references PR discussion at https://github.com/MoosicBox/MoosicBox/pull/175#discussion_r2462901200
                         Decision: BLOCKED - This change was already discussed and reverted. Will not make it again.
                         REGRESSION_CHECK_END
                         ```

                      2. **Check Claims Against Code**
                         - Read the code at `{1}/src/` to verify README claims
                         - Compare API examples with actual function signatures
                         - Check `{1}/Cargo.toml` for dependency accuracy

                      3. **Identify Only Fundamental Issues**
                         - Focus on factual errors and critical omissions
                         - Ignore style, wording, or organizational preferences

                      ## Scope

                      Only modify `{1}/README.md`. Do not change any code files.

                      ## Output

                      - If the README is fundamentally accurate and complete: **Make NO changes**
                      - If you find fundamental errors: Fix them with minimal edits
                      - Do not "improve" things that are already correct',
                          matrix.package.name, matrix.package.path)
                      }}

                  claude_args: |
                      --allowedTools Edit,Read,Write
                      ${{ inputs.model && format('--model {0}', inputs.model) || vars.README_CLAUDE_MODEL && format('--model {0}', vars.README_CLAUDE_MODEL) || '' }}
                      ${{ inputs.max_tokens && format('--max-tokens {0}', inputs.max_tokens) || vars.README_MAX_TOKENS && format('--max-tokens {0}', vars.README_MAX_TOKENS) || '' }}
                      ${{ inputs.max_turns && format('--max-turns {0}', inputs.max_turns) || vars.README_MAX_TURNS && format('--max-turns {0}', vars.README_MAX_TURNS) || '' }}

            - name: Upload Claude output for review
              if: always() && steps.check_readme.outputs.exists == 'true'
              uses: actions/upload-artifact@v4
              with:
                  name: claude-output-${{ matrix.package.name }}
                  path: output.txt
                  if-no-files-found: ignore
                  retention-days: 7

            - name: Format README with prettier
              if: steps.check_readme.outputs.exists == 'true'
              run: |
                  # Check if README was modified by Claude
                  if git diff --name-only | grep -q "${{ matrix.package.path }}/README.md" || \
                     git diff --cached --name-only | grep -q "${{ matrix.package.path }}/README.md"; then

                    echo "ðŸ“ README modified, running prettier..."

                    if ! npx -y prettier --write "${{ matrix.package.path }}/README.md"; then
                      echo "âš ï¸ Prettier failed - continuing with unformatted README"
                      echo "This may indicate malformed markdown in Claude's output"
                    else
                      echo "âœ… Prettier formatting complete"
                    fi
                  else
                    echo "â„¹ï¸ No README changes detected, skipping prettier"
                  fi

            - name: Commit changes with resilient push
              if: steps.check_readme.outputs.exists == 'true'
              run: |
                  # Remove output.txt so it doesn't get committed
                  rm -f output.txt

                  # Check if any changes were made by Claude
                  if [ -n "$(git status --porcelain)" ]; then

                    echo "ðŸ“ Changes detected, preparing commit..."
                    git add -A

                    # Extract commit message from Claude output (JSONL format)
                    if [ -f output.txt ]; then
                      COMMIT_DESC=$(grep "COMMIT_MESSAGE_START" output.txt | head -1 | jq -r '.message.content[0].text | split("COMMIT_MESSAGE_START\n")[1] | split("\nCOMMIT_MESSAGE_END")[0]')
                    fi

                    if [ -n "$COMMIT_DESC" ]; then
                      echo "ðŸ“‹ Extracted commit description:"
                      echo "$COMMIT_DESC"
                      git commit -m "docs(${{ matrix.package.name }}): update README for accuracy" -m "$COMMIT_DESC"
                    else
                      echo "âš ï¸ No commit description found, using simple message"
                      git commit -m "docs(${{ matrix.package.name }}): update README for accuracy"
                    fi

                    MAX_RETRIES=5
                    RETRY_COUNT=0
                    PUSH_SUCCESS=false

                    while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$PUSH_SUCCESS" = "false" ]; do
                      echo "Push attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES"

                      if git pull --rebase origin ${{ needs.create-branch.outputs.branch-name }}; then
                        if git push origin ${{ needs.create-branch.outputs.branch-name }}; then
                          echo "âœ… Successfully pushed changes"
                          PUSH_SUCCESS=true
                        else
                          echo "âš ï¸ Push failed, will retry..."
                          RETRY_COUNT=$((RETRY_COUNT + 1))
                          sleep $((RETRY_COUNT * 2))
                        fi
                      else
                        echo "âš ï¸ Rebase failed, resolving and retrying..."
                        git rebase --abort || true
                        git fetch origin ${{ needs.create-branch.outputs.branch-name }}
                        RETRY_COUNT=$((RETRY_COUNT + 1))
                        sleep $((RETRY_COUNT * 2))
                      fi
                    done

                    if [ "$PUSH_SUCCESS" = "false" ]; then
                      echo "âŒ Failed to push after $MAX_RETRIES attempts"
                      exit 1
                    fi
                  else
                    echo "â„¹ï¸ No changes detected, skipping commit"
                    echo "ðŸ“‹ Git status shows:"
                    git status --short
                  fi

    update-root-readme:
        name: Update root README
        runs-on: ubuntu-latest
        needs: [create-branch]

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: ${{ needs.create-branch.outputs.branch-name }}
                  fetch-depth: 0
                  token: ${{ secrets.MOOSICBOX_BOT_UPGRADES_TOKEN }}

            - name: Configure Git
              run: |
                  git config user.name "MoosicBoxBot"
                  git config user.email "MoosicBoxBot@gmail.com"

            - name: Update root README with Claude
              uses: BSteffaniak/claude-code-action@dev
              with:
                  claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
                  github_token: ${{ secrets.MOOSICBOX_BOT_UPGRADES_TOKEN }}

                  prompt: |
                      ${{
                        (inputs.existing_branch != '' && inputs.prompt_override != '' &&
                          format('# Additional Root README Refinement

                      This is a refinement pass on an existing README update branch.

                      ## Previous Context
                      The root README.md has already been reviewed and potentially updated.

                      ## Additional Guidance
                      {0}

                      ## Requirements
                      - Review the current state of the README
                      - Apply the additional guidance above
                      - Only make changes that align with the new guidance
                      - Preserve previous improvements unless they conflict with new guidance

                      Focus on incremental improvements based on the additional guidance.',
                          inputs.prompt_override))
                        ||
                        (inputs.prompt_override != '' && inputs.prompt_override)
                        ||
                        (vars.ROOT_README_UPDATE_PROMPT != '' && vars.ROOT_README_UPDATE_PROMPT)
                        ||
                        '# Root README Accuracy Review

                      ## âš ï¸ CRITICAL CONSTRAINT: FUNDAMENTAL ERRORS ONLY

                      You may ONLY make changes for these reasons:

                      **Fundamentally Incorrect:**
                      - README claims a major feature that doesn''t exist in the codebase
                      - Installation/setup instructions that are completely wrong
                      - Technology/platform claims that are false
                      - Command examples that don''t work
                      - Broken links to documentation or resources

                      **Fundamentally Incomplete:**
                      - Major implemented features completely missing from README
                      - Critical setup steps absent
                      - Essential prerequisites not mentioned

                      **FORBIDDEN Changes (even if you think they would be "better"):**
                      - âŒ Rewording for clarity, style, or tone
                      - âŒ Reorganizing sections
                      - âŒ Marketing copy improvements
                      - âŒ Adding more detail when basics are covered
                      - âŒ Formatting/markdown changes
                      - âŒ Expanding package descriptions that are already accurate
                      - âŒ Minor completeness improvements
                      - âŒ Removing features that are configured/enabled even if not fully implemented
                      - âŒ Nitpicking wording differences when the meaning is substantially the same
                      - âŒ Including specific line numbers in code references (e.g., `src/file.rs:123`) - line numbers change frequently and should be omitted
                      - âŒ Including specific counts of tests/test cases (e.g., "5 test cases", "10 tests") - test counts change frequently and should be omitted

                      **Decision Rule:**
                      Before making ANY change, ask:
                      1. "Would someone reading this be fundamentally MISLED about what this project does or how to use it?"
                      2. "Am I removing information that is technically accurate based on configuration/capabilities?"
                      - If either is NO â†’ Leave it alone
                      - If both are YES â†’ Fix it (it''s fundamental)

                      **Examples of FORBIDDEN changes:**
                      - Changing "System notifications, tray integration, and OS-specific features" to just "System notification support" (removing configured capabilities)
                      - Changing "Media keys, notifications, and system tray" to "Media keys and notifications" (removing tray mention when capability exists)
                      - Simplifying feature lists that accurately describe configured functionality

                      ## ðŸ“– USER-FACING FOCUS - Don''t Document Implementation Details

                      The root README is for **users and potential contributors**, not deep implementation details.

                      **DO Document:**
                      - âœ… What the project does (high-level purpose)
                      - âœ… How to install and run it
                      - âœ… Major features users will interact with
                      - âœ… Public APIs and user-facing interfaces
                      - âœ… Configuration options for deployment
                      - âœ… Getting started guide

                      **DO NOT Document:**
                      - âŒ Internal architecture implementation details
                      - âŒ Development tooling specifics (save for DEVELOPMENT.md)
                      - âŒ Internal macros or helper utilities
                      - âŒ Build system internals
                      - âŒ Implementation-specific optimizations (caches, thread pools, etc.)
                      - âŒ Internal module organization (unless relevant to users)

                      **Decision Rule for Documentation:**
                      Ask: "Does a user evaluating or using MoosicBox need to know this?"
                      - YES (helps them understand/use the project) â†’ Document it
                      - NO (only relevant to maintainers/contributors) â†’ Leave it out

                      **Focus on:** What users need to evaluate, install, configure, and use MoosicBox successfully.

                      ## ðŸ“ Commit Message Instructions

                      If you make changes to the root README, you MUST provide a commit message description.

                      At the END of your response, include a section formatted EXACTLY as follows:
                      ```
                      COMMIT_MESSAGE_START
                      - Brief description of what changed and why (1-2 sentences)
                      - Additional changes if applicable
                      COMMIT_MESSAGE_END
                      ```

                      Example:
                      ```
                      COMMIT_MESSAGE_START
                      - Corrected installation command from npm to cargo based on actual build system
                      - Removed claim about Docker support as docker-compose.yml is not present in repository
                      COMMIT_MESSAGE_END
                      ```

                      Requirements:
                      - Keep each bullet point concise (1-2 sentences max)
                      - Focus on WHAT changed and WHY (the fundamental issue)
                      - Use bullet points with dashes (-)
                      - Do not include code snippets or line numbers
                      - If no changes needed, output "No changes required - documentation is accurate"

                      ## Verification Process

                      1. **ðŸš« MANDATORY Git History Regression Check**

                         Before making ANY change to the README, you MUST check git history for the SPECIFIC LINES you want to modify.

                         **Required Commands:**
                         For each line or section you want to change, run:
                         ```bash
                         # Replace LINE_NUMBER with the actual line number you want to modify
                         # Add +/- 5 lines of context to catch related changes
                         git log -L LINE_NUMBER,+1:README.md --format="%H %s%n%b"

                         # For a section spanning multiple lines (e.g., lines 50-60):
                         git log -L 50,60:README.md --format="%H %s%n%b"
                         ```

                         **What to Look For:**
                         - **Revert commits**: Messages containing "revert", "revert back to", "prefer X format", "changed back to"
                         - **PR discussion references**: Look for "Triggered-by:" URLs in commit messages
                         - **Explicit reasoning**: Commit messages explaining "prefer X because Y" or "more concise", "better for readability"
                         - **Multiple attempts**: If the same change appears 2+ times in history, this is a STRONG SIGNAL

                         **Blocking Rules (NON-NEGOTIABLE):**
                         - âŒ **If you find a revert commit for the exact change you want to make**: STOP. DO NOT make that change.
                         - âŒ **If the same change was reverted 2+ times**: HARD STOP. The maintainers have decided against it.
                         - âŒ **If a commit contains "Triggered-by:" with a GitHub PR/discussion URL**: You MUST read that discussion to understand the reasoning before proceeding.
                         - âŒ **If unclear after reading history**: Leave it alone. Document the uncertainty in your output for human review.

                         **Decision Process:**
                         1. Run `git log -L` for the specific line(s) you want to change
                         2. Read ALL commit messages in the history (no arbitrary limits - check FULL history)
                         3. If you see a revert or "Triggered-by:" reference:
                            a. Extract the discussion URL if present
                            b. Understand why the change was reverted
                            c. If your proposed change matches what was reverted: BLOCK IT
                         4. Document your findings in a `REGRESSION_CHECK` block (format below)

                         **Required Output Format:**
                         For EVERY change you consider making, include this in your response:
                         ```
                         REGRESSION_CHECK_START
                         File: README.md
                         Line(s): [specific line numbers]
                         Proposed change: [brief description of what you wanted to do]
                         Git history checked: YES
                         Revert found: [YES/NO]
                         Revert details: [commit hash and reasoning if YES, otherwise "None found"]
                         Decision: [PROCEED/BLOCKED - explanation]
                         REGRESSION_CHECK_END
                         ```

                         **Example of BLOCKED change:**
                         ```
                         REGRESSION_CHECK_START
                         File: README.md
                         Line(s): 125
                         Proposed change: Change CLI example format from X to Y
                         Git history checked: YES
                         Revert found: YES
                         Revert details: Commit abc123 reverted this exact change with reasoning "prefer X for better readability" and references PR discussion
                         Decision: BLOCKED - This change was already discussed and reverted. Will not make it again.
                         REGRESSION_CHECK_END
                         ```

                      2. **Check Major Claims**
                         - Verify listed features actually exist in the codebase
                         - Test that installation instructions are accurate
                         - Confirm technology stack claims

                      3. **Identify Only Fundamental Issues**
                         - Focus on factual errors and critical omissions
                         - Ignore wording preferences and organizational choices

                      ## Output

                      - If the README is fundamentally accurate and complete: **Make NO changes**
                      - If you find fundamental errors: Fix them with minimal edits
                      - Do not "improve" things that are already correct
                      - Preserve the existing tone and marketing approach'
                      }}

                  claude_args: |
                      --allowedTools Edit,Read,Write
                      ${{ inputs.model && format('--model {0}', inputs.model) || vars.README_CLAUDE_MODEL && format('--model {0}', vars.README_CLAUDE_MODEL) || '' }}
                      ${{ inputs.max_tokens && format('--max-tokens {0}', inputs.max_tokens) || vars.README_MAX_TOKENS && format('--max-tokens {0}', vars.README_MAX_TOKENS) || '' }}
                      ${{ inputs.max_turns && format('--max-turns {0}', inputs.max_turns) || vars.README_MAX_TURNS && format('--max-turns {0}', vars.README_MAX_TURNS) || '' }}

            - name: Upload Claude output for review
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: claude-output-root-readme
                  path: output.txt
                  if-no-files-found: ignore
                  retention-days: 7

            - name: Format README with prettier
              run: |
                  # Check if README was modified by Claude
                  if git diff --name-only | grep -q "^README.md$" || \
                     git diff --cached --name-only | grep -q "^README.md$"; then

                    echo "ðŸ“ Root README modified, running prettier..."

                    if ! npx -y prettier --write "README.md"; then
                      echo "âš ï¸ Prettier failed - continuing with unformatted README"
                      echo "This may indicate malformed markdown in Claude's output"
                    else
                      echo "âœ… Prettier formatting complete"
                    fi
                  else
                    echo "â„¹ï¸ No README changes detected, skipping prettier"
                  fi

            - name: Commit changes with resilient push
              run: |
                  # Remove output.txt so it doesn't get committed
                  rm -f output.txt

                  # Check if any changes were made by Claude
                  if [ -n "$(git status --porcelain)" ]; then

                    echo "ðŸ“ Changes detected, preparing commit..."
                    git add -A

                    # Extract commit message from Claude output (JSONL format)
                    if [ -f output.txt ]; then
                      COMMIT_DESC=$(grep "COMMIT_MESSAGE_START" output.txt | head -1 | jq -r '.message.content[0].text | split("COMMIT_MESSAGE_START\n")[1] | split("\nCOMMIT_MESSAGE_END")[0]')
                    fi

                    if [ -n "$COMMIT_DESC" ]; then
                      echo "ðŸ“‹ Extracted commit description:"
                      echo "$COMMIT_DESC"
                      git commit -m "docs(root): update README for accuracy" -m "$COMMIT_DESC"
                    else
                      echo "âš ï¸ No commit description found, using simple message"
                      git commit -m "docs(root): update README for accuracy"
                    fi

                    MAX_RETRIES=5
                    RETRY_COUNT=0
                    PUSH_SUCCESS=false

                    while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$PUSH_SUCCESS" = "false" ]; do
                      echo "Push attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES"

                      if git pull --rebase origin ${{ needs.create-branch.outputs.branch-name }}; then
                        if git push origin ${{ needs.create-branch.outputs.branch-name }}; then
                          echo "âœ… Successfully pushed changes"
                          PUSH_SUCCESS=true
                        else
                          echo "âš ï¸ Push failed, will retry..."
                          RETRY_COUNT=$((RETRY_COUNT + 1))
                          sleep $((RETRY_COUNT * 2))
                        fi
                      else
                        echo "âš ï¸ Rebase failed, resolving and retrying..."
                        git rebase --abort || true
                        git fetch origin ${{ needs.create-branch.outputs.branch-name }}
                        RETRY_COUNT=$((RETRY_COUNT + 1))
                        sleep $((RETRY_COUNT * 2))
                      fi
                    done

                    if [ "$PUSH_SUCCESS" = "false" ]; then
                      echo "âŒ Failed to push after $MAX_RETRIES attempts"
                      exit 1
                    fi
                  else
                    echo "â„¹ï¸ No changes detected, skipping commit"
                    echo "ðŸ“‹ Git status shows:"
                    git status --short
                  fi

    create-pr:
        name: Create Pull Request
        runs-on: ubuntu-latest
        needs: [create-branch, update-readmes, update-root-readme]
        if: always() && needs.create-branch.result == 'success'

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: ${{ needs.create-branch.outputs.branch-name }}
                  token: ${{ secrets.MOOSICBOX_BOT_UPGRADES_TOKEN }}
                  fetch-depth: 0

            - name: Check for changes
              id: check_changes
              run: |
                  CHANGES=$(git diff origin/master --name-only | grep README.md || true)
                  if [ -n "$CHANGES" ]; then
                    echo "has_changes=true" >> $GITHUB_OUTPUT
                    echo "Found changes in:"
                    echo "$CHANGES"
                  else
                    echo "has_changes=false" >> $GITHUB_OUTPUT
                    echo "No README changes detected"
                  fi

            - name: Create Pull Request
              if: steps.check_changes.outputs.has_changes == 'true'
              env:
                  GH_TOKEN: ${{ secrets.MOOSICBOX_BOT_UPGRADES_TOKEN }}
              run: |
                  EXISTING_PR=$(gh pr list --head ${{ needs.create-branch.outputs.branch-name }} --json number --jq '.[0].number' || echo "")

                  PR_BODY=$(cat <<'EOF'
                  ## ðŸ¤– Automated README Accuracy Review

                  ${{ needs.create-branch.outputs.is-new == 'false' && '### ðŸ”„ This is a refinement pass on an existing branch' || '' }}

                  This PR contains automated updates to ensure all README files accurately reflect the current state of the codebase.

                  ### ðŸ“‹ What was reviewed:
                  ${{ inputs.packages != '' && format('- Specific packages: {0}', inputs.packages) || '- âœ… Root README.md\n- âœ… All package READMEs' }}

                  ${{ inputs.prompt_override != '' && format('### ðŸŽ¯ Additional Guidance Applied:\n```\n{0}\n```\n', inputs.prompt_override) || '' }}

                  ${{ inputs.model != '' && format('### ðŸ¤– Model Used:\n`{0}`\n', inputs.model) || '' }}

                  ### ðŸ” Review focus:
                  - Verified that claimed features are actually implemented
                  - Marked future/planned features clearly
                  - Updated outdated information
                  - Ensured code examples match actual APIs
                  - Checked dependency claims against Cargo.toml files

                  ### âš™ï¸ Process:
                  - Used parallel job execution (one per package)
                  - Each package README reviewed independently by Claude
                  - All changes consolidated on branch: `${{ needs.create-branch.outputs.branch-name }}`
                  ${{ needs.create-branch.outputs.is-new == 'false' && '- **Refinement mode**: Building on previous updates' || '' }}

                  ### ðŸ“ Review Guidelines:
                  1. **Verify Accuracy**: Check that updates correctly reflect the code
                  2. **Future Features**: Ensure planned features are appropriately marked
                  3. **Completeness**: Confirm no important features were removed incorrectly
                  4. **Tone**: Verify documentation maintains appropriate technical tone

                  ### âš ï¸ Important Notes:
                  - This is an automated review - human oversight is essential
                  - Claude may be overly conservative or miss nuances
                  - Please review all changes carefully before merging

                  ---

                  **Generated by**: [Claude Code Action](https://github.com/marketplace/actions/claude-code-action-official)
                  **Branch**: `${{ needs.create-branch.outputs.branch-name }}`
                  **Run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
                  ${{ needs.create-branch.outputs.is-new == 'false' && '**Refinement of**: Previous updates on this branch' || '**Initial run**: New branch created' }}
                  EOF
                  )

                  if [ -n "$EXISTING_PR" ]; then
                    echo "âœ… PR #$EXISTING_PR already exists, updating it"
                    gh pr edit $EXISTING_PR --body "$PR_BODY"
                    echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
                    echo "pr_url=$(gh pr view $EXISTING_PR --json url --jq '.url')" >> $GITHUB_OUTPUT
                  else
                    echo "ðŸ“ Creating new PR"
                    PR_URL=$(gh pr create \
                      --base master \
                      --head ${{ needs.create-branch.outputs.branch-name }} \
                      --title 'ðŸ“ Automated README Accuracy Updates (${{ needs.create-branch.outputs.branch-date }})' \
                      --label documentation,automated,readme-updates \
                      --body "$PR_BODY")

                    echo "âœ… Created PR: $PR_URL"
                    echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

                    PR_NUMBER=$(echo "$PR_URL" | grep -oP '\d+$')
                    echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
                  fi

            - name: No changes summary
              if: steps.check_changes.outputs.has_changes == 'false'
              run: |
                  echo "âœ… No README updates needed - all documentation appears accurate"
