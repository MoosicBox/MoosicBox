name: README Accuracy Checker

on:
    schedule:
        - cron: "0 8 * * 1"
    workflow_dispatch:
        inputs:
            existing_branch:
                description: "Use existing branch (leave empty to create new)"
                required: false
                type: string
                default: ""

            packages:
                description: "Comma-separated packages (leave empty for all)"
                required: false
                type: string
                default: ""

            prompt_override:
                description: "Additional guidance or custom prompt"
                required: false
                type: string
                default: ""

            model:
                description: "Claude model to use (leave empty for latest default)"
                required: false
                type: choice
                options:
                    - ""
                    - "claude-sonnet-4-5-20250929"
                    - "claude-opus-4-1-20250805"
                    - "claude-opus-4-20250514"
                    - "claude-sonnet-4-20250514"
                    - "claude-3-7-sonnet-20250219"
                    - "claude-3-5-haiku-20241022"
                    - "claude-3-haiku-20240307"
                default: ""

            max_tokens:
                description: "Maximum tokens per request (leave empty for default)"
                required: false
                type: string
                default: ""

            max_turns:
                description: "Maximum conversation turns (leave empty for default)"
                required: false
                type: string
                default: ""

permissions:
    id-token: write
    contents: write
    pull-requests: write

env:
    CARGO_TERM_COLOR: always

jobs:
    create-branch:
        name: Create or use existing branch
        runs-on: ubuntu-latest
        outputs:
            branch-name: ${{ steps.branch.outputs.branch_name }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.MOOSICBOX_BOT_UPGRADES_TOKEN }}
                  fetch-depth: 0

            - name: Create branch
              id: branch
              uses: ./.github/actions/claude-checker
              with:
                  command: create-branch
                  github_token: ${{ secrets.MOOSICBOX_BOT_UPGRADES_TOKEN }}
                  branch_prefix: readme-updates
                  branch_name: ${{ inputs.existing_branch }}
                  existing_branch: ${{ inputs.existing_branch != '' && 'true' || 'false' }}

    determine-packages:
        name: Determine packages to update
        runs-on: ubuntu-latest
        needs: [create-branch]
        outputs:
            matrix: ${{ steps.analyze.outputs.matrix }}
            has-packages: ${{ steps.analyze.outputs.has-changes }}
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - uses: dtolnay/rust-toolchain@stable

            - name: Generate package matrix
              id: analyze
              uses: ./.github/actions/clippier
              with:
                  command: packages
                  packages: ${{ github.event.inputs.packages }}
                  skip-on-no-changes: "false"
                  force-full-matrix-condition: "true"
                  os-suffix: "-latest"
                  os: "ubuntu"

    update-readmes:
        name: Update ${{ matrix.package.name }}
        runs-on: ubuntu-latest
        needs: [create-branch, determine-packages]
        if: needs.determine-packages.outputs.has-packages == 'true'
        strategy:
            fail-fast: false
            max-parallel: 20
            matrix:
                package: ${{ fromJson(needs.determine-packages.outputs.matrix) }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: ${{ needs.create-branch.outputs.branch-name }}
                  fetch-depth: 0
                  token: ${{ secrets.MOOSICBOX_BOT_UPGRADES_TOKEN }}

            - name: Configure Git
              run: |
                  git config user.name "MoosicBoxBot"
                  git config user.email "MoosicBoxBot@gmail.com"

            - name: Check if README exists
              id: check_readme
              run: |
                  if [ -f "${{ matrix.package.path }}/README.md" ]; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                    echo "No README found for ${{ matrix.package.name }}, skipping"
                  fi

            - name: Update README with Claude
              if: steps.check_readme.outputs.exists == 'true'
              id: claude
              uses: ./.github/actions/claude-checker
              with:
                  command: check
                  github_token: ${{ secrets.MOOSICBOX_BOT_UPGRADES_TOKEN }}
                  claude_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
                  prompt_template: readme

                  enable_execution_details: "true"
                  enable_execution_details_artifact: "true"
                  artifact_name_prefix: readme
                  artifact_package_name: ${{ matrix.package.name }}
                  artifact_retention_days: "30"
                  execution_details_script: .github/scripts/format-execution-details.sh

                  template_vars: |
                      package_name: ${{ matrix.package.name }}
                      package_path: ${{ matrix.package.path }}
                      custom_guidelines: ${{ inputs.prompt_override }}
                      is_refinement_pass: ${{ inputs.existing_branch != '' && inputs.prompt_override != '' && 'true' || 'false' }}

                  branch_name: ${{ needs.create-branch.outputs.branch-name }}
                  auto_commit: true
                  enable_resilient_push: true
                  push_max_retries: 5
                  extract_commit_message: true

                  model: ${{ inputs.model }}
                  max_tokens: ${{ inputs.max_tokens }}
                  max_turns: ${{ inputs.max_turns }}
                  claude_args: --allowedTools Edit,Read,Write,Bash

            - name: Format README with prettier
              if: always() && steps.check_readme.outputs.exists == 'true'
              run: |
                  README_PATH="${{ matrix.package.path }}/README.md"
                  if [ -f "$README_PATH" ]; then
                    npx -y prettier --write "$README_PATH"

                    if [ -n "$(git status --porcelain)" ]; then
                      git add "$README_PATH"
                      git commit --amend --no-edit
                      git push --force-with-lease origin ${{ needs.create-branch.outputs.branch-name }}
                    fi
                  fi

            - name: Upload Claude output for review
              if: always() && steps.check_readme.outputs.exists == 'true'
              uses: actions/upload-artifact@v4
              with:
                  name: claude-output-${{ matrix.package.name }}
                  path: output.txt
                  if-no-files-found: ignore
                  retention-days: 7

    update-root-readme:
        name: Update root README
        runs-on: ubuntu-latest
        needs: [create-branch]

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: ${{ needs.create-branch.outputs.branch-name }}
                  fetch-depth: 0
                  token: ${{ secrets.MOOSICBOX_BOT_UPGRADES_TOKEN }}

            - name: Configure Git
              run: |
                  git config user.name "MoosicBoxBot"
                  git config user.email "MoosicBoxBot@gmail.com"

            - name: Update root README with Claude
              uses: ./.github/actions/claude-checker
              with:
                  command: check
                  github_token: ${{ secrets.MOOSICBOX_BOT_UPGRADES_TOKEN }}
                  claude_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
                  prompt_template: readme

                  template_vars: |
                      package_path: .
                      is_root_readme: true
                      custom_guidelines: ${{ inputs.prompt_override }}
                      is_refinement_pass: ${{ inputs.existing_branch != '' && inputs.prompt_override != '' && 'true' || 'false' }}

                  branch_name: ${{ needs.create-branch.outputs.branch-name }}
                  auto_commit: true
                  enable_resilient_push: true
                  push_max_retries: 5
                  extract_commit_message: true

                  model: ${{ inputs.model }}
                  max_tokens: ${{ inputs.max_tokens }}
                  max_turns: ${{ inputs.max_turns }}
                  claude_args: --allowedTools Edit,Read,Write,Bash

            - name: Format README with prettier
              if: always()
              run: |
                  if [ -f "README.md" ]; then
                    npx -y prettier --write "README.md"

                    if [ -n "$(git status --porcelain)" ]; then
                      git add README.md
                      git commit --amend --no-edit
                      git push --force-with-lease origin ${{ needs.create-branch.outputs.branch-name }}
                    fi
                  fi

            - name: Upload Claude output for review
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: claude-output-root-readme
                  path: output.txt
                  if-no-files-found: ignore
                  retention-days: 7

    create-pr:
        name: Create Pull Request
        runs-on: ubuntu-latest
        needs: [create-branch, update-readmes, update-root-readme]
        if: always() && needs.create-branch.result == 'success'

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: ${{ needs.create-branch.outputs.branch-name }}
                  token: ${{ secrets.MOOSICBOX_BOT_UPGRADES_TOKEN }}
                  fetch-depth: 0

            - name: Check for changes
              id: check_changes
              run: |
                  CHANGES=$(git diff origin/master --name-only | grep README.md || true)
                  if [ -n "$CHANGES" ]; then
                    echo "has_changes=true" >> $GITHUB_OUTPUT
                    echo "Found changes in:"
                    echo "$CHANGES"
                  else
                    echo "has_changes=false" >> $GITHUB_OUTPUT
                    echo "No README changes detected"
                  fi

            - name: Create Pull Request
              if: steps.check_changes.outputs.has_changes == 'true'
              uses: ./.github/actions/claude-checker
              with:
                  command: create-pr
                  github_token: ${{ secrets.MOOSICBOX_BOT_UPGRADES_TOKEN }}
                  branch_name: ${{ needs.create-branch.outputs.branch-name }}
                  pr_base_branch: master
                  pr_title: "ğŸ“ Automated README Accuracy Updates"
                  pr_body: |
                      ## ğŸ¤– Automated README Accuracy Review

                      This PR contains automated updates to ensure all README files accurately reflect the current state of the codebase.

                      ### ğŸ“‹ What was reviewed:
                      ${{ inputs.packages != '' && format('- Specific packages: {0}', inputs.packages) || '- âœ… Root README.md\n- âœ… All package READMEs' }}

                      ${{ inputs.prompt_override != '' && format('### ğŸ¯ Additional Guidance Applied:\n```\n{0}\n```\n', inputs.prompt_override) || '' }}

                      ${{ inputs.model != '' && format('### ğŸ¤– Model Used:\n`{0}`\n', inputs.model) || '' }}

                      ### ğŸ” Review focus:
                      - Verified that claimed features are actually implemented
                      - Marked future/planned features clearly
                      - Updated outdated information
                      - Ensured code examples match actual APIs
                      - Checked dependency claims against Cargo.toml files

                      ### âš™ï¸ Process:
                      - Used parallel job execution (one per package)
                      - Each package README reviewed independently by Claude
                      - All changes consolidated on branch: `${branch_name}`

                      ### ğŸ“ Review Guidelines:
                      1. **Verify Accuracy**: Check that updates correctly reflect the code
                      2. **Future Features**: Ensure planned features are appropriately marked
                      3. **Completeness**: Confirm no important features were removed incorrectly
                      4. **Tone**: Verify documentation maintains appropriate technical tone

                      ### âš ï¸ Important Notes:
                      - This is an automated review - human oversight is essential
                      - Claude may be overly conservative or miss nuances
                      - Please review all changes carefully before merging

                      ---

                      **Generated by**: [Claude Checker Action](https://github.com/MoosicBox/MoosicBox/tree/master/.github/actions/claude-checker)
                      **Branch**: `${branch_name}`
                      **Run**: ${run_url}
                  pr_labels: "automated,documentation,readme-updates"
                  pr_skip_if_no_changes: true

            - name: No changes summary
              if: steps.check_changes.outputs.has_changes == 'false'
              run: |
                  echo "âœ… No README updates needed - all documentation appears accurate"
