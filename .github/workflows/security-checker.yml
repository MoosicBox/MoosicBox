name: Security Checker

on:
    schedule:
        - cron: "0 6 * * 1" # Weekly on Monday at 6am UTC
    workflow_dispatch:
        inputs:
            existing_branch:
                description: "Use existing branch (leave empty to create new)"
                required: false
                type: string
                default: ""

            severity_threshold:
                description: "Minimum severity to report and fix"
                required: false
                type: choice
                options:
                    - "low"
                    - "medium"
                    - "high"
                    - "critical"
                default: "medium"

            prompt_override:
                description: "Additional guidance or custom prompt"
                required: false
                type: string
                default: ""

            model:
                description: "Claude model to use (leave empty for latest default)"
                required: false
                type: choice
                options:
                    - ""
                    - "claude-opus-4-5-20251101"
                    - "claude-sonnet-4-5-20250929"
                    - "claude-opus-4-1-20250805"
                    - "claude-opus-4-20250514"
                    - "claude-sonnet-4-20250514"
                    - "claude-3-7-sonnet-20250219"
                    - "claude-3-5-haiku-20241022"
                    - "claude-3-haiku-20240307"
                default: ""

            max_turns:
                description: "Maximum conversation turns (leave empty for default)"
                required: false
                type: string
                default: ""

permissions:
    id-token: write
    contents: write
    pull-requests: write

env:
    CARGO_TERM_COLOR: always

jobs:
    create-branch:
        name: Create or use existing branch
        runs-on: ubuntu-latest
        outputs:
            branch-name: ${{ steps.branch.outputs.branch_name }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.MOOSICBOX_BOT_UPGRADES_TOKEN }}
                  fetch-depth: 0

            - name: Create branch
              id: branch
              uses: ./.github/actions/claude-checker
              with:
                  command: create-branch
                  github_token: ${{ secrets.MOOSICBOX_BOT_UPGRADES_TOKEN }}
                  branch_prefix: security-audit
                  branch_name: ${{ inputs.existing_branch }}
                  existing_branch: ${{ inputs.existing_branch != '' && 'true' || 'false' }}

    check-security:
        name: Check workspace for security vulnerabilities
        runs-on: ubuntu-latest
        needs: [create-branch]

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: ${{ needs.create-branch.outputs.branch-name }}
                  fetch-depth: 0
                  token: ${{ secrets.MOOSICBOX_BOT_UPGRADES_TOKEN }}

            - name: Configure Git
              run: |
                  git config user.name "MoosicBoxBot"
                  git config user.email "MoosicBoxBot@gmail.com"

            - name: Get workspace toolchains
              id: toolchains
              uses: ./.github/actions/clippier
              with:
                  command: workspace-toolchains
                  os: ubuntu
                  jq-filter: '.toolchains |= map(select(. != "free_disk_space"))'

            - name: Setup workspace CI environment
              uses: ./.github/actions/clippier
              with:
                  command: workspace-setup
                  os: ubuntu
                  workspace-toolchains-json: ${{ steps.toolchains.outputs.matrix }}

            - name: Install cargo-audit
              run: |
                  cargo install cargo-audit --locked

            - name: Check security with Claude
              id: claude
              uses: ./.github/actions/claude-checker
              with:
                  command: check
                  github_token: ${{ secrets.MOOSICBOX_BOT_UPGRADES_TOKEN }}
                  claude_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
                  prompt_template_file: .github/prompts/security.md

                  enable_execution_details_summary: "true"
                  summary_title: "üîí Security Audit"
                  execution_details_script: .github/scripts/format-execution-details.sh

                  template_vars: |
                      severity_threshold: ${{ inputs.severity_threshold || 'medium' }}
                      custom_guidelines: ${{ inputs.prompt_override }}

                  branch_name: ${{ needs.create-branch.outputs.branch-name }}
                  auto_commit: true
                  enable_resilient_push: true
                  push_max_retries: 5
                  extract_commit_message: true

                  model: ${{ inputs.model }}
                  max_turns: ${{ inputs.max_turns }}
                  claude_args: --allowedTools Edit,Read,Write,Bash,Glob,Grep

            - name: Upload Claude output for review
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: claude-output-security
                  path: output.txt
                  if-no-files-found: ignore
                  retention-days: 7

    create-pr:
        name: Create Pull Request
        runs-on: ubuntu-latest
        needs: [create-branch, check-security]
        if: always() && needs.create-branch.result == 'success'

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: ${{ needs.create-branch.outputs.branch-name }}
                  token: ${{ secrets.MOOSICBOX_BOT_UPGRADES_TOKEN }}
                  fetch-depth: 0

            - name: Check for changes
              id: check_changes
              run: |
                  CHANGES=$(git diff origin/master --name-only | grep -E "\.(rs|toml)$" || true)
                  if [ -n "$CHANGES" ]; then
                    echo "has_changes=true" >> $GITHUB_OUTPUT
                    echo "Found changes in:"
                    echo "$CHANGES"
                  else
                    echo "has_changes=false" >> $GITHUB_OUTPUT
                    echo "No Rust or TOML file changes detected"
                  fi

            - name: Create Pull Request
              if: steps.check_changes.outputs.has_changes == 'true'
              uses: ./.github/actions/claude-checker
              with:
                  command: create-pr
                  github_token: ${{ secrets.MOOSICBOX_BOT_UPGRADES_TOKEN }}
                  branch_name: ${{ needs.create-branch.outputs.branch-name }}
                  pr_base_branch: master
                  pr_title: "üîí Automated Security Fixes"
                  pr_body: |
                      ## ü§ñ Automated Security Audit

                      This PR contains fixes for security vulnerabilities identified by automated scanning.

                      ${{ inputs.prompt_override != '' && format('### üéØ Additional Guidance Applied:\n```\n{0}\n```\n', inputs.prompt_override) || '' }}

                      ${{ inputs.model != '' && format('### ü§ñ Model Used:\n`{0}`\n', inputs.model) || '' }}

                      ### üéöÔ∏è Severity Threshold: `${{ inputs.severity_threshold || 'medium' }}`

                      Issues at or above this severity level were reported and fixed where possible.

                      ### üîç Categories Checked:

                      **Input Validation & Injection**
                      - Path traversal vulnerabilities
                      - Command injection
                      - SQL injection
                      - Format string issues

                      **Integer & Memory Safety**
                      - Integer overflow/underflow
                      - Unbounded allocations
                      - Panic-inducing operations on untrusted input

                      **Cryptography**
                      - Weak/insecure random number generation
                      - Hardcoded secrets
                      - Weak hashing algorithms

                      **Error Handling & Information Disclosure**
                      - Sensitive data in error messages
                      - Logging of credentials
                      - Silent error swallowing

                      **Unsafe Code**
                      - Unnecessary unsafe blocks
                      - Missing safety documentation
                      - Undefined behavior patterns

                      **Authentication & Authorization**
                      - Missing auth checks
                      - Credential handling issues
                      - Session management

                      **Concurrency**
                      - Data races in unsafe code
                      - TOCTOU vulnerabilities

                      **Dependencies**
                      - Known CVEs via `cargo audit`
                      - Unmaintained dependencies

                      ### üìã Packages Excluded:
                      - `clippier`, `bloaty`, `gpipe` (build/tooling packages)
                      - Test code (unless testing security features)
                      - Example code (documented but not fixed)

                      ### ‚öôÔ∏è Verification:
                      All changes have been verified with:
                      - `cargo fmt`
                      - `cargo test`
                      - `cargo clippy --all-targets -- -D warnings`
                      - `cargo-machete --with-metadata`
                      - `prettier` and `taplo` formatting

                      ### üìù Review Guidelines:
                      1. **Verify Fixes**: Ensure security fixes don't break functionality
                      2. **Check False Positives**: Some findings may be false positives requiring context
                      3. **Architectural Issues**: Some issues may require design changes beyond this PR
                      4. **Test Coverage**: Consider adding tests for security-critical paths

                      ### ‚ö†Ô∏è Important Notes:
                      - This is an automated security scan - human oversight is essential
                      - Critical/High severity issues should be prioritized for review
                      - Some findings may require architectural changes not addressed here
                      - Consider running additional security tools (cargo-deny, etc.)

                      ---

                      **Generated by**: [Claude Checker Action](https://github.com/MoosicBox/MoosicBox/tree/master/.github/actions/claude-checker)
                      **Branch**: `${branch_name}`
                      **Run**: ${run_url}
                  pr_labels: "automated,security"
                  pr_skip_if_no_changes: true

            - name: No changes summary
              if: steps.check_changes.outputs.has_changes == 'false'
              run: |
                  echo "‚úÖ No security fixes needed - no vulnerabilities found at or above severity threshold"
