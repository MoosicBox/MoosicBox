name: Build Docker Images

on:
    push:
        branches: ['master', 'edge']
        paths:
            - .github/workflows/build-server-docker-image.yml
            - packages/**
            - '**/*.toml'
            - '**/Cargo.lock'
            - free_disk_space.sh
            - '!packages/marketing_site/*.ts'
            - '!packages/marketing_site/*.json'
            - '!packages/marketing_site/pnpm-lock.yaml'
            - '!packages/marketing_site/*.mjs'
            - '!packages/marketing_site/*.js'
            - '!packages/marketing_site/*.md'
            - '!packages/marketing_site/.prettierignore'
            - '!packages/marketing_site/hyperchad/**'
            - '!packages/marketing_site/infra/**'
            - '!packages/hyperchad/renderer/vanilla_js/web/**'
            - '!**/*.nix'
            - '!**/Dockerfile'
            - '!**/*.Dockerfile'
            - '!**/*.dockerignore'
    pull_request:
        branches: ['master', 'edge']
    workflow_dispatch:
        inputs:
            edge:
                description: 'Edge'
                required: false
                type: boolean
                default: false
env:
    CARGO_TERM_COLOR: always

jobs:
    build:
        strategy:
            fail-fast: false

            matrix:
                project:
                    - name: server
                      dockerfile: packages/server/Server.Dockerfile

                    - name: tunnel_server
                      dockerfile: packages/tunnel_server/TunnelServer.Dockerfile

                    - name: load_balancer
                      dockerfile: packages/load_balancer/LoadBalancer.Dockerfile

        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Enable patches
              if: ${{ github.event_name == 'schedule' || github.event.inputs.edge == true }}
              run: |
                  git config user.name "MoosicBoxBot"
                  git config user.email "MoosicBoxBot@gmail.com"
                  git checkout edge
                  git rebase master

            - name: Generate Dockerfile
              shell: bash
              run: |
                  ./generate-dockerfiles.sh ${{ matrix.project.name }}

            - name: Build Dockerfile
              shell: bash
              run: |
                  docker build . -f ${{ matrix.project.dockerfile }}
