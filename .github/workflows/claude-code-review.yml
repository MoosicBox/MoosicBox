name: Claude Code Review

on:
    pull_request:
        types: [opened, synchronize]
        # Optional: Only run on specific file changes
        # paths:
        #   - "src/**/*.ts"
        #   - "src/**/*.tsx"
        #   - "src/**/*.js"
        #   - "src/**/*.jsx"

jobs:
    claude-review:
        # Optional: Filter by PR author
        # if: |
        #   github.event.pull_request.user.login == 'external-contributor' ||
        #   github.event.pull_request.user.login == 'new-developer' ||
        #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

        runs-on: ubuntu-latest
        permissions:
            contents: read
            pull-requests: read
            issues: read
            id-token: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 1

            - name: Check organization membership
              env:
                  GH_TOKEN: ${{ secrets.MOOSICBOX_BOT_UPGRADES_TOKEN }}
              run: |
                  ACTOR="${{ github.event.pull_request.user.login }}"

                  echo "Checking if $ACTOR is an organization member..."

                  if gh api "/orgs/${{ github.repository_owner }}/members/$ACTOR" --silent 2>/dev/null; then
                    echo "✅ $ACTOR is an organization member"
                  else
                    echo "❌ $ACTOR is NOT an organization member - terminating workflow"

                    cat > /tmp/denied.txt << 'EOF'
                  🚫 **Automated Code Review Unavailable**

                  Automated Claude code reviews are only available for pull requests from organization members.
                  EOF

                    gh pr comment ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --body-file /tmp/denied.txt
                    exit 1
                  fi

            - name: Run Claude Code Review
              id: claude-review
              uses: BSteffaniak/claude-code-action@main
              with:
                  claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
                  use_sticky_comment: "true"
                  prompt: |
                      REPO: ${{ github.repository }}
                      PR NUMBER: ${{ github.event.pull_request.number }}

                      Please review this pull request and provide feedback on:
                      - Code quality and best practices
                      - Potential bugs or issues
                      - Performance considerations
                      - Security concerns
                      - Test coverage

                      Use the repository's AGENTS.md for guidance on style and conventions. Be constructive and helpful in your feedback.

                      Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.

                  # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
                  # or https://docs.claude.com/en/docs/claude-code/cli-reference for available options
                  claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'
